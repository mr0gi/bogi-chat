<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>RETRO CHAT</title>
<style>
  body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; margin: 0; }
  #nickScreen { text-align: center; margin-top: 100px; }
  #nickInput { background: #001100; color: #0f0; border: 2px solid #0f0; padding: 10px; width: 300px; font-size: 1.2em; }
  #chatScreen { display: none; }
  #chat { border: 2px solid #0f0; padding: 15px; height: 70vh; overflow-y: scroll; background: #001100; margin-bottom: 10px; }
  .msg { margin: 8px 0; }
  .you { color: #0f0; }
  .other { color: #0ff; }
  #message { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; width: 70%; }
  #send { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; width: 28%; }
  #status { color: #ff0; font-size: 1.2em; margin-bottom: 10px; }
</style>
</head>
<body>
<div id="nickScreen">
  <h1>RETRO CHAT</h1>
  <p>Kullanıcı adını gir</p>
  <input type="text" id="nickInput" placeholder="Nickin..." maxlength="20">
  <br><br>
  <button onclick="startChat()">Giriş Yap</button>
</div>

<div id="chatScreen">
  <p id="status">Bağlanıyor...</p>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Mesaj yaz... (Enter ile gönder)" onkeypress="if(event.keyCode==13) sendMsg();">
  <button id="send" onclick="sendMsg()">Gönder</button>
</div>

<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<script>
let nick = '';
let dc = null;
let channel = null;
const pusher = new Pusher('BURAYA_KEY_GELCEK', {
  cluster: 'BURAYA_CLUSTER_GELCEK',
  encrypted: true
});

function startChat() {
  nick = document.getElementById('nickInput').value.trim();
  if (!nick) {
    alert('Bir nick gir!');
    return;
  }

  document.getElementById('nickScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'block';
  document.getElementById('status').textContent = 'Bağlantı kuruluyor...';

  channel = pusher.subscribe('retro-chat');
  channel.bind('signal', handleSignal);
  channel.bind('message', handleMessage);

  // Bağlantı kurmak için signaling başlat
  startSignaling();
}

function startSignaling() {
  // Basit signaling: İlk giren offer oluşturur, ikinci giren answer verir
  const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.onicecandidate = e => {
    if (e.candidate) {
      channel.trigger('client-signal', { type: 'candidate', candidate: e.candidate });
    }
  };

  pc.ontrack = e => console.log('Track geldi');

  pc.ondatachannel = e => {
    dc = e.channel;
    setupDataChannel();
  };

  // İki kişi kontrolü: İlk giren offer yaratır
  channel.bind('pusher:subscription_succeeded', () => {
    if (channel.members.count === 1) {
      // İlk kişi offer yaratır
      dc = pc.createDataChannel('chat');
      setupDataChannel();
      pc.createOffer()
        .then(offer => pc.setLocalDescription(offer))
        .then(() => {
          channel.trigger('client-signal', { type: 'offer', offer: pc.localDescription });
        });
    } else {
      document.getElementById('status').textContent = 'Karşı taraf bağlandı!';
    }
  });

  function setupDataChannel() {
    dc.onmessage = e => {
      let div = document.createElement('div');
      div.className = 'msg other';
      div.textContent = e.data;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    };
    dc.onopen = () => {
      document.getElementById('status').textContent = 'BAĞLANDI! Mesajlaşmaya başla.';
    };
  }

  function handleSignal(data) {
    if (data.type === 'offer') {
      pc.setRemoteDescription(data.offer)
        .then(() => pc.createAnswer())
        .then(answer => pc.setLocalDescription(answer))
        .then(() => channel.trigger('client-signal', { type: 'answer', answer: pc.localDescription }));
    } else if (data.type === 'answer') {
      pc.setRemoteDescription(data.answer);
    } else if (data.type === 'candidate') {
      pc.addIceCandidate(data.candidate);
    }
  }

  function handleMessage(data) {
    let div = document.createElement('div');
    div.className = 'msg other';
    div.textContent = data.nick + ': ' + data.text;
    document.getElementById('chat').appendChild(div);
    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  }

  // Mesaj gönderme
  window.sendMsg = function() {
    let msg = document.getElementById('message').value.trim();
    if (msg && dc && dc.readyState === 'open') {
      dc.send(nick + ': ' + msg);
      let div = document.createElement('div');
      div.className = 'msg you';
      div.textContent = nick + ': ' + msg;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
      document.getElementById('message').value = '';
    } else if (msg) {
      // Eğer P2P çalışmazsa fallback (Pusher üzerinden)
      channel.trigger('client-message', { nick, text: msg });
    }
  };
}
</script>
</body>
</html>
