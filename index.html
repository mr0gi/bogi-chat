<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Retro P2P Chat</title>
<style>
  body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; margin: 0; }
  h1 { text-align: center; }
  #setup { text-align: center; margin: 50px; }
  textarea, input, button { 
    background: #001100; color: #0f0; border: 2px solid #0f0; 
    padding: 10px; font-family: 'Courier New'; font-size: 1em; 
  }
  textarea { width: 80%; height: 150px; }
  input { width: 80%; margin: 10px 0; }
  button { width: 40%; margin: 10px; cursor: pointer; }
  #chatArea { display: none; text-align: left; }
  #chat { border: 2px solid #0f0; padding: 15px; height: 65vh; overflow-y: scroll; background: #001100; margin-bottom: 10px; }
  .msg { margin: 8px 0; }
  .you { color: #0f0; }
  .other { color: #0ff; }
  #message { width: 70%; }
  #sendBtn { width: 28%; }
  #status { color: #ff0; text-align: center; font-size: 1.2em; }
</style>
</head>
<body>
<h1>RETRO P2P CHAT</h1>

<div id="setup">
  <p><strong>Nickini gir:</strong></p>
  <input type="text" id="nick" placeholder="Nickin..." maxlength="20">
  
  <p style="margin-top:30px;"><strong>1. kişiysen:</strong> Bağlantı kodunu oluştur</p>
  <button onclick="createOffer()">Bağlantı Kodunu Oluştur</button>
  
  <p style="margin-top:30px;"><strong>2. kişiysen:</strong> Arkadaşından gelen kodu buraya yapıştır</p>
  <textarea id="remoteCode" placeholder="Kodu buraya yapıştır..."></textarea>
  <br>
  <button onclick="pasteAnswer()">Kodu Yapıştır ve Bağlan</button>
</div>

<div id="chatArea">
  <p id="status">Bağlanıyor...</p>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Mesaj yaz... (Enter ile gönder)" onkeypress="if(event.key===13) sendMsg();">
  <button id="sendBtn" onclick="sendMsg()">Gönder</button>
</div>

<script>
let pc = null;
let dc = null;
let myNick = '';

function createOffer() {
  myNick = document.getElementById('nick').value.trim() || 'Kişi1';
  if (!myNick) { alert('Nick gir!'); return; }

  initPC();
  dc = pc.createDataChannel('chat');
  setupDataChannel();

  pc.createOffer()
    .then(offer => pc.setLocalDescription(offer))
    .then(() => {
      setTimeout(() => {  // ICE gathering bitene kadar bekle
        const code = btoa(JSON.stringify(pc.localDescription));
        document.getElementById('remoteCode').value = code;
        alert('Bu kodu arkadaşına gönder:\n\n' + code + '\n\n(Kopyalamak için kutuya uzun basabilirsin)');
        document.getElementById('status').textContent = 'Kod oluşturuldu! Karşı tarafın yapıştırmasını bekle...';
        document.getElementById('chatArea').style.display = 'block';
        document.getElementById('setup').style.display = 'none';
      }, 1000);
    });
}

function pasteAnswer() {
  myNick = document.getElementById('nick').value.trim() || 'Kişi2';
  if (!myNick) { alert('Nick gir!'); return; }

  const code = document.getElementById('remoteCode').value.trim();
  if (!code) { alert('Kod yapıştır!'); return; }

  initPC();
  const sdp = JSON.parse(atob(code));

  pc.setRemoteDescription(sdp)
    .then(() => pc.createAnswer())
    .then(answer => pc.setLocalDescription(answer))
    .then(() => {
      setTimeout(() => {
        const answerCode = btoa(JSON.stringify(pc.localDescription));
        alert('Şimdi bu kodu 1. kişiye geri gönder:\n\n' + answerCode);
      }, 1000);
    });

  pc.ondatachannel = e => {
    dc = e.channel;
    setupDataChannel();
  };
}

function initPC() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });

  pc.onicecandidate = e => {
    if (e.candidate === null && pc.localDescription) {
      // Tamamlanmış SDP'yi güncelle (gerekirse)
    }
  };

  document.getElementById('chatArea').style.display = 'block';
  document.getElementById('setup').style.display = 'none';
}

function setupDataChannel() {
  dc.onopen = () => {
    document.getElementById('status').textContent = 'BAĞLANDI! Artık mesajlaşabilirsiniz.';
  };

  dc.onmessage = e => {
    addMessage('other', e.data);
  };
}

function addMessage(type, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  div.textContent = text;
  document.getElementById('chat').appendChild(div);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
}

function sendMsg() {
  const msgInput = document.getElementById('message');
  const msg = msgInput.value.trim();
  if (msg && dc && dc.readyState === 'open') {
    const fullMsg = myNick + ': ' + msg;
    dc.send(fullMsg);
    addMessage('you', fullMsg);
    msgInput.value = '';
  }
}
</script>
</body>
</html>
