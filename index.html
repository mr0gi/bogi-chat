<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>RETRO CHAT</title>
<style>
  body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; margin: 0; }
  #nickScreen { text-align: center; margin-top: 100px; }
  #nickInput { background: #001100; color: #0f0; border: 2px solid #0f0; padding: 10px; width: 300px; font-size: 1.2em; }
  #chatScreen { display: none; }
  #chat { border: 2px solid #0f0; padding: 15px; height: 70vh; overflow-y: scroll; background: #001100; margin-bottom: 10px; }
  .msg { margin: 8px 0; }
  .you { color: #0f0; }
  .other { color: #0ff; }
  #message { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; width: 70%; }
  #send { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; width: 28%; }
  #status { color: #ff0; font-size: 1.2em; margin-bottom: 10px; }
</style>
</head>
<body>
<div id="nickScreen">
  <h1>RETRO CHAT</h1>
  <p>Nickini gir (sadece 2 kişi girebilir)</p>
  <input type="text" id="nickInput" placeholder="Nickin..." maxlength="20">
  <br><br>
  <button onclick="startChat()">Giriş Yap</button>
</div>

<div id="chatScreen">
  <p id="status">Bağlanıyor...</p>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Mesaj yaz... (Enter ile gönder)" onkeypress="if(event.keyCode==13) sendMsg();">
  <button id="send" onclick="sendMsg()">Gönder</button>
</div>

<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<script>
let nick = '';
let dc = null;
let pc = null;
let channel = null;

const pusher = new Pusher('B402b381f5f24c1c5764b', {  // <-- Burayı kendi key'inle değiştir!
  cluster: 'eu',  // örneğin 'eu'
  forceTLS: true
});

function startChat() {
  nick = document.getElementById('nickInput').value.trim();
  if (!nick) {
    alert('Nick gir!');
    return;
  }

  document.getElementById('nickScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'block';

  // Tek global private kanal kullanıyoruz
  channel = pusher.subscribe('private-retro-chat');

  channel.bind('pusher:subscription_succeeded', () => {
    const members = channel.members;
    if (members.count > 2) {
      document.getElementById('status').textContent = 'Oda dolu! Başka zaman dene.';
      return;
    }

    document.getElementById('status').textContent = members.count === 1 ? 'Karşı tarafı bekliyor...' : 'Bağlandı! Mesajlaşabilirsiniz.';

    if (members.count === 1) {
      // İlk kişi: offer oluştur
      startWebRTC(true);
    }
  });

  channel.bind('pusher:subscription_error', (err) => {
    document.getElementById('status').textContent = 'Bağlantı hatası: ' + err.error;
  });

  // Signaling mesajlarını al
  channel.bind('client-signal', (data) => {
    handleSignal(data);
  });
}

function startWebRTC(isInitiator) {
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      channel.trigger('client-signal', { type: 'candidate', candidate: e.candidate });
    }
  };

  if (isInitiator) {
    dc = pc.createDataChannel('chat');
    setupDataChannel();
    pc.createOffer()
      .then(offer => pc.setLocalDescription(offer))
      .then(() => channel.trigger('client-signal', { type: 'offer', sdp: pc.localDescription }));
  } else {
    pc.ondatachannel = (e) => {
      dc = e.channel;
      setupDataChannel();
    };
  }
}

function handleSignal(data) {
  if (data.type === 'offer') {
    startWebRTC(false);
    pc.setRemoteDescription(data.sdp)
      .then(() => pc.createAnswer())
      .then(answer => pc.setLocalDescription(answer))
      .then(() => channel.trigger('client-signal', { type: 'answer', sdp: pc.localDescription }));
  } else if (data.type === 'answer') {
    pc.setRemoteDescription(data.sdp);
  } else if (data.type === 'candidate') {
    pc.addIceCandidate(data.candidate);
  }
}

function setupDataChannel() {
  dc.onopen = () => {
    document.getElementById('status').textContent = 'BAĞLANDI! Mesajlaşabilirsiniz.';
  };

  dc.onmessage = (e) => {
    addMessage('other', e.data);
  };
}

function addMessage(type, text) {
  let div = document.createElement('div');
  div.className = 'msg ' + type;
  div.textContent = text;
  document.getElementById('chat').appendChild(div);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
}

function sendMsg() {
  let msg = document.getElementById('message').value.trim();
  if (msg && dc && dc.readyState === 'open') {
    dc.send(nick + ': ' + msg);
    addMessage('you', nick + ': ' + msg);
    document.getElementById('message').value = '';
  }
}
</script>
</body>
</html>
